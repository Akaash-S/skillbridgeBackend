version: '3.8'

services:
  skillbridge:
    build: 
      context: .
      dockerfile: Dockerfile
    container_name: skillbridge-app
    ports:
      - "80:80"
      - "443:443"
    environment:
      # Application Settings
      - FLASK_ENV=production
      - PORT=8080
      - SECRET_KEY=${SECRET_KEY}
      
      # Firebase Configuration
      - FIREBASE_SERVICE_ACCOUNT_BASE64=${FIREBASE_SERVICE_ACCOUNT_BASE64}
      - DISABLE_FIREBASE=${DISABLE_FIREBASE:-false}
      
      # API Keys
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - YOUTUBE_API_KEY=${YOUTUBE_API_KEY}
      - ADZUNA_APP_ID=${ADZUNA_APP_ID}
      - ADZUNA_APP_KEY=${ADZUNA_APP_KEY}
      
      # MFA Configuration
      - MFA_ISSUER_NAME=${MFA_ISSUER_NAME:-SkillBridge}
      - MFA_SECRET_KEY=${MFA_SECRET_KEY}
      
      # Email Configuration
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
      - SMTP_USE_TLS=${SMTP_USE_TLS:-true}
      - EMAIL_FROM_NAME=${EMAIL_FROM_NAME:-SkillBridge}
      - EMAIL_SUPPORT=${EMAIL_SUPPORT}
      - EMAIL_RATE_LIMIT=${EMAIL_RATE_LIMIT:-10}
      - EMAIL_BATCH_SIZE=${EMAIL_BATCH_SIZE:-50}
      
      # CORS Configuration
      - CORS_ORIGINS=${CORS_ORIGINS:-https://skillbridge.asolvitra.tech,https://www.skillbridge.asolvitra.tech}
      
      # Redis Configuration
      - REDIS_PASSWORD=${REDIS_PASSWORD:-changeme123}
      
      # GCP Specific
      - GOOGLE_CLOUD_PROJECT=${GOOGLE_CLOUD_PROJECT}
      - GCP_REGION=${GCP_REGION:-us-central1}
      
    volumes:
      # Persistent logs
      - ./logs:/app/logs
      - ./nginx/ssl:/etc/nginx/ssl
      # Let's Encrypt certificates (if using)
      - /etc/letsencrypt:/etc/letsencrypt:ro
      # Supervisor logs
      - supervisor_logs:/var/log/supervisor
      
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
      
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"
        
    # Resource limits for GCP Compute Engine
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1.0'
        reservations:
          memory: 1G
          cpus: '0.5'

volumes:
  supervisor_logs:

networks:
  default:
    name: skillbridge-network